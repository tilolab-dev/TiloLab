generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model Admin {
  id               Int               @id @default(autoincrement())
  name             String
  visits           Int               @default(0)
  sales            Int               @default(0)
  avgCheck         Int               @default(0)
  metrics          AdminMetric[]
  popularProducts  PopularProduct[]
  promotedProducts PromotedProduct[]
  sender           AdminSender[]
  notification     AdminNotification[]
}

model AdminSender {
  id              Int                 @id @default(autoincrement())
  name            String
  surname         String
  family          String
  phoneNumber     String
  postOffice      String?
  postomat        String?

  orders          Order[]

  admins Admin[]
}

model AdminMetric {
  id             Int      @id @default(autoincrement())
  date           DateTime @default(now())
  visits         Int
  sales          Int
  avgCheck       Int
  yearSales      Int
  allEarning     Int
  users          Int
  allClients     Int
  allOrders      Int
  lastOrders     Boolean
  activity       Boolean
  productRate    Boolean
  activeOrders   Boolean
  orderGeography Boolean
  returnCancel   Boolean
  periods        Boolean
  userMetrics    Boolean
  sellMetrics    Boolean
  sellOrder      Boolean
  adminId        Int
  admin          Admin    @relation(fields: [adminId], references: [id])
}

model Category {
  id            Int                   @id @default(autoincrement())
  group         String                @unique
  listPosition  Int                   @default(0)
  visible       Boolean
  categoryImg   String?
  parentId      Int?
  parent        Category?             @relation("CategoryParent", fields: [parentId], references: [id], onDelete: Cascade)
  subcategories Category[]            @relation("CategoryParent")
  translations  CategoryTranslation[]
  products      Product[]

  @@index([parentId])
}

model CategoryTranslation {
  id          Int      @id @default(autoincrement())
  categoryId  Int
  language    String
  title       String
  description String?
  groupText   String?
  Category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([language])
}

model Product {
  id               Int                  @id @default(autoincrement())
  categoryId       Int
  visible          Boolean
  stockState       Boolean
  stockValue       Int?                 @default(0)
  discountPercent  Int?
  productSize      String
  productPrice     Float
  stockReserved    Int?                 @default(0)
  orderItems       OrderItem[]
  popularProducts  PopularProduct[]
  category         Category             @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  img              ProductImg[]
  options          ProductOptions[]
  translations     ProductTranslation[]
  promotedProducts PromotedProduct[]

  @@index([categoryId])
  @@index([productSize])
}

model ProductOptions {
  id           Int                         @id @default(autoincrement())
  optionId     Int
  optionImg    String
  optionPrice  Float?
  Product      Product                     @relation(fields: [optionId], references: [id], onDelete: Cascade)
  translations ProductOptionsTranslation[]

  @@index([optionId])
}

model ProductImg {
  id      Int     @id @default(autoincrement())
  imgId   Int
  path    String
  Product Product @relation(fields: [imgId], references: [id], onDelete: Cascade)

  @@index([imgId])
}

model ProductTranslation {
  id                 Int     @id @default(autoincrement())
  productId          Int
  language           String
  title              String
  productDescription String?
  productColor       String
  productMaterial    String
  productManufacture String? @default("-")
  Product            Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([language])
}

model ProductOptionsTranslation {
  id         Int            @id @default(autoincrement())
  optionId   Int
  language   String
  optionInfo String
  Option     ProductOptions @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@index([optionId])
  @@index([language])
}

model PopularProduct {
  id        Int      @id @default(autoincrement())
  adminId   Int
  productId Int
  addedAt   DateTime @default(now())
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model PromotedProduct {
  id        Int      @id @default(autoincrement())
  adminId   Int
  productId Int
  addedAt   DateTime @default(now())
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model User {
  id             Int            @id @default(autoincrement())
  username       String?        @unique
  userSurname    String?
  userAvatar     String?
  userFamily     String?
  email          String?        @unique
  phoneNumber    String?
  password       String?
  createdAt      DateTime       @default(now())
  role           String         @default("guest")
  telegramId     String?        @unique
  telegramChatId String?        @unique
  telegramRole   TgRoles?       @default(CLIENT)
  adresses       Adress[]
  // Notification   Notification[]
  settings       UserSetting[]
  orders         Order[]

  @@index([phoneNumber])
}

model Adress {
  id          Int     @id @default(autoincrement())
  userId      Int
  street      String
  city        String
  country     String
  homeAdress  String
  postCompany String
  postOffice  String
  postomat    String
  postalCode  String?
  postIndex   String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserSetting {
  id      Int    @id @default(autoincrement())
  userId  Int
  setting String
  value   String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Order {
  id            String        @id(map: "Order_pkey") @default(uuid())
  userId        Int?
  status        OrderStatus   @default(NEW)
  createdAt     DateTime      @default(now())
  paymentMethod String?
  totalPrice    Float
  orderNumber   String        @unique(map: "Order_orderNumber_key")
  expiresAt     DateTime?
  orderItems    OrderItem[]
  payments      Payment?
  shippingInfo  ShippingInfo?
  user          User?         @relation(fields: [userId], references: [id], map: "Order_userId_fkey")

  deliveryTtn   String?

  @@index([status], map: "Order_status_idx")
  @@index([userId], map: "Order_userId_idx")
  @@map("orders")
  adminSenders AdminSender[]
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   String
  productId Int
  quantity  Int     @default(1)
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
}

model ShippingInfo {
  id             Int     @id @default(autoincrement())
  orderId        String  @unique
  recipient      String
  phoneNumber    String
  deliveryMethod String?
  postCompany    String?
  postOffice     String?
  postomat       String?
  city           String
  address        String?
  country        String
  order          Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([city])
  @@index([country])
}

model News {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  visible   Boolean
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model Payment {
  id          String        @id @default(uuid())
  orderId     String        @unique
  monoInvoice String        @unique
  status      PaymentStatus @default(PENDING)
  amount      Float
  provider    String        @default("monobank")
  payload     Json?
  createdAt   DateTime      @default(now())
  order       Order         @relation(fields: [orderId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model AdminNotification {
  id        Int               @id @default(autoincrement())
  message   String
  isReaded  Boolean           @default(false)
  createdAt DateTime          @default(now())
  type      NotificationType  @default(WARNING)
  // User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // @@index([userId])

  admins Admin[]
}

enum NotificationType {
  WARNING
  ERROR
  SUCCESS
  DEFAULT
}

enum TgRoles {
  GUEST
  ADMIN
  CLIENT
}

enum OrderStatus {
  NEW
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  RETURNED
  CANCELED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}
